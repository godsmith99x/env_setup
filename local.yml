---
#    ___             _                  _  _    _     
#   / _ \  ___    __| | ___  _ __ ___  (_)| |_ | |__  
#  / /_\/ / _ \  / _` |/ __|| '_ ` _ \ | || __|| '_ \ 
# / /_\\ | (_) || (_| |\__ \| | | | | || || |_ | | | |
# \____/  \___/  \__,_||___/|_| |_| |_||_| \__||_| |_|
#



- hosts: localhost
  connection: local
  become: true
  vars:
    user_name: "nerdheaven"

  tasks:
  - name: Update all packages to their latest version
    apt:
      name: "*"
      state: latest

  - name: Install packages
    apt: 
      pkg: 
        - neovim
        - tree
        - zsh
        - autojump
        - yamllint
        - python3-pip

  - name: Remove useless packages from the cache
    apt:
      autoremove: yes


  - name: Install nvm
    become: true
    become_user: "{{user_name}}"
    command: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash

  - name: Create .local/share/nvim/site/autoload directory
    file: 
      path: /home/{{user_name}}/.local/share/nvim/site/autoload
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Download vim-plug package manager 
    become: true
    become_user: "{{user_name}}"
    get_url: 
      url: https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
      dest: /home/{{user_name}}/.local/share/nvim/site/autoload/plug.vim

  - name: Create .config/nvim directory
    file: 
      path: /home/{{user_name}}/.config/nvim
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Copy nvim conf files
    copy:
      src: "{{item}}"
      dest: /home/{{user_name}}/.config/nvim/
      owner: "{{user_name}}"
      group: "{{user_name}}"
    with_fileglob:
      - files/nvim/*

  - name: Copy bashrc file
    copy:
      src: files/bashrc
      dest: /home/{{user_name}}/.bashrc
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Create .oh-my-zsh_install directory
    file: 
      path: /home/{{user_name}}/.oh-my-zsh_install
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Download oh-my-zsh install.sh
    become: true
    become_user: "{{user_name}}"
    get_url: 
      url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh 
      dest: /home/{{user_name}}/.oh-my-zsh_install/

  - name: Make oh-my-zsh install.sh executable
    become: true
    command: chmod 751 /home/{{user_name}}/.oh-my-zsh_install/install.sh 

  - name: Install oh-my-zsh
    become: true
    become_user: "{{user_name}}"
    command: /home/{{user_name}}/.oh-my-zsh_install/install.sh --unattended

  - name: Copy zshrc file
    copy:
      src: files/zshrc/zshrc
      dest: /home/{{user_name}}/.zshrc
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Create .oh-my-zsh/custom/plugins/zsh-autosuggestions directory
    file: 
      path: /home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-autosuggestions
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Clone zsh-autosuggestion git repo
    become: true
    become_user: "{{user_name}}"
    ansible.builtin.git:
      repo: "https://github.com/zsh-users/zsh-autosuggestions"
      dest: "/home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"

  - name: Create .oh-my-zsh/custom/plugins/zsh-completions directory
    file: 
      path: /home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-completions
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Clone zsh-completions git repo
    become: true
    become_user: "{{user_name}}"
    ansible.builtin.git:
      repo: "https://github.com/zsh-users/zsh-completions"
      dest: "/home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-completions"

  - name: Create .oh-my-zsh/custom/plugins/zsh-syntax-highlighting directory
    file: 
      path: /home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting
      state: directory
      owner: "{{user_name}}"
      group: "{{user_name}}"

  - name: Clone zsh-syntax-highlighting git repo
    become: true
    become_user: "{{user_name}}"
    ansible.builtin.git:
      repo: "https://github.com/zsh-users/zsh-syntax-highlighting"
      dest: "/home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"

  - name: Clone almostontop git repo
    become: true
    become_user: "{{user_name}}"
    ansible.builtin.git:
      repo: "https://github.com/Valiev/almostontop.git"
      dest: "/home/{{user_name}}/.oh-my-zsh/custom/plugins/almostontop"

  - name: Clone zsh-autocomplete git repo
    become: true
    become_user: "{{user_name}}"
    ansible.builtin.git:
      repo: "https://github.com/marlonrichert/zsh-autocomplete.git"
      dest: "/home/{{user_name}}/.oh-my-zsh/custom/plugins/zsh-autocomplete"

  - name: Change to zsh shell
    become_user: "{{user_name}}"
    command: chsh -s $(which zsh)

  - name: Copy ssh secure config file
    become: true
    copy:
      src: files/ssh/sshd_config
      dest: /etc/ssh/sshd_config

  - name: Restart ssh service
    become: true
    command: systemctl restart sshd.service
